name: Microservice Build

on:
  push:
    branches:
      - main
    # paths:
    #   - 'applications/microservices/**'
    # #   - '!**.md'
  workflow_dispatch:

jobs:
  detect-and-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.1'

      - name: Fetch full git history
        run: git fetch --unshallow

      - name: Detect changed microservices
        id: detect
        run: |
          echo "Changed folders:"
          BASE_SHA=${{ github.event.before }}
          if [ -z "$BASE_SHA" ] || ! git cat-file -e $BASE_SHA; then
            BASE_SHA=$(git rev-parse HEAD^)
          fi
          changed=$(git diff --name-only $BASE_SHA ${{ github.sha }} | grep '^applications/microservices/' | cut -d '/' -f3 | sort -u)
          echo "$changed"
          echo "services=$changed" >> "$GITHUB_OUTPUT"

      - name: Build changed microservices
        if: steps.detect.outputs.services != ''
        run: |
          IFS=$'\n'
          for service in ${{ steps.detect.outputs.services }}; do
            echo "‚û°Ô∏è Processing $service..."
            cd applications/microservices/$service
            echo "üßπ Running go mod tidy & vendor..."
            go mod tidy
            go mod vendor
            echo "üê≥ Building Docker image using docker-compose-ext-server.yml..."
            cd ../../../
            docker-compose -f docker-compose-ext-server.yml build $service
            echo "‚úÖ Done with $service"
          done
