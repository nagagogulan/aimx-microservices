
name: Microservice Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  detect-and-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.1'

      - name: Fetch full git history
        run: git fetch --unshallow || true

      - name: Detect changed microservices
        id: detect
        run: |
          echo "Changed folders:"
          BASE_SHA="${{ github.event.before }}"
          if [ -z "$BASE_SHA" ] || ! git cat-file -e "$BASE_SHA"; then
            BASE_SHA=$(git rev-parse HEAD^)
          fi
          HEAD_SHA="${{ github.sha }}"
          changed=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '^applications/' | cut -d '/' -f2 | sort -u)
          echo "$changed"
          echo "services<<EOF" >> $GITHUB_OUTPUT
          echo "$changed" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build changed microservices
        if: steps.detect.outputs.services != ''
        run: |
          IFS=$'\n'
          for service in ${{ steps.detect.outputs.services }}; do
            echo "‚û°Ô∏è Processing $service..."
            cd applications/$service
            echo "üßπ Running go mod tidy & vendor..."
            go mod tidy
            go mod vendor
            echo "üê≥ Building Docker image using docker-compose-ext-server.yml..."
            cd ../../
            docker-compose -f docker-compose-ext-server.yml build $service
            echo "‚úÖ Done with $service"
          done
