name: Detect Changed Services

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  detect:
    name: Detect Changed Services in applications/
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important: needed for full git history

      - name: Set up Git info
        id: git-info
        run: |
          echo "Finding base and head commits..."
          BASE_SHA=$(git merge-base origin/main HEAD || git rev-parse HEAD^)
          HEAD_SHA=$(git rev-parse HEAD)

          echo "BASE_SHA=$BASE_SHA" >> $GITHUB_ENV
          echo "HEAD_SHA=$HEAD_SHA" >> $GITHUB_ENV

      - name: Detect changed services
        id: detect
        run: |
          echo "Changed folders:"
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          if ! git cat-file -e "$BASE_SHA"; then
            echo "Invalid BASE_SHA: $BASE_SHA"
            exit 0
          fi

          changed=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '^applications/' | cut -d '/' -f2 | sort -u)

          echo "$changed"
          echo "services<<EOF" >> $GITHUB_OUTPUT
          echo "$changed" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Print changed services
        run: |
          echo "Detected changes in:"
          echo "${{ steps.detect.outputs.services }}"
