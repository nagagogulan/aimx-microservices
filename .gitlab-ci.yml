image: golang:1.23

stages:
  - clone
  - build
  - deploy

variables:
  DOCKER_IMAGE_PREFIX: nagagogulan/aimx
  GIT_REPO_URL: "https://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@github.com/PecozQ/aimx-library.git"
  GIT_BRANCH: "dev"
  SERVICES: "identity forms roles dataset profile user_management"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375

clone:
  image: alpine:latest
  stage: clone
  script:
    - apk update && apk add git
    - echo "Cloning repository..."
    - git clone -b "$GIT_BRANCH" "$GIT_REPO_URL" source

build-identity:
  image: docker:latest  # Docker CLI image
  stage: build
  tags:
    - docker

  services:
    - name: docker:latest
      alias: docker

  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
    GOPRIVATE: github.com/PecozQ/*
  
  before_script:
  - apk add --no-cache curl git
  - curl -LO https://go.dev/dl/go1.23.1.linux-amd64.tar.gz
  - rm -rf /usr/local/go && tar -C /usr/local -xzf go1.23.1.linux-amd64.tar.gz
  - export PATH=$PATH:/usr/local/go/bin

  - apt-get update && apt-get install -y docker.io
  - export DOCKER_HOST="unix:///var/run/docker.sock"

  - go version
  - git config --global url."https://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@github.com/".insteadOf "https://github.com/"

  script:
    - cd applications/dataset
    - go mod tidy
    - go mod vendor
    - echo "Building Docker image for identity service"
    - docker build -t dataset:latest .



  


deploy_microservices:
  stage: deploy
  image: alpine:latest
  only:
    - dev
  before_script:
    - apk add --no-cache openssh bash
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
  script:
    - |
      bash -c '
      ssh $EC2_USER@$EC2_HOST "
        docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        for SERVICE in $SERVICES; do
          echo \"Deploying \$SERVICE...\"
          docker pull $DOCKER_IMAGE_PREFIX-\$SERVICE:latest
          docker ps -q --filter name=\$SERVICE | xargs -r docker stop || true
          docker ps -aq --filter name=\$SERVICE | xargs -r docker rm || true
          case \$SERVICE in
            identity) docker run -d --name identity -p 8081:8081 $DOCKER_IMAGE_PREFIX-identity:latest ;;
            forms) docker run -d --name forms -p 8082:8082 $DOCKER_IMAGE_PREFIX-forms:latest ;;
            roles) docker run -d --name roles -p 8083:8083 $DOCKER_IMAGE_PREFIX-roles:latest ;;
            dataset) docker run -d --name dataset -p 8084:8084 $DOCKER_IMAGE_PREFIX-dataset:latest ;;
            profile) docker run -d --name profile -p 8085:8085 $DOCKER_IMAGE_PREFIX-profile:latest ;;
            user_management) docker run -d --name user_management -p 8086:8086 $DOCKER_IMAGE_PREFIX-user_management:latest ;;
          esac
        done
      "
      '
