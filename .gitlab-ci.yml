build_microservices:
  stage: build
  image: golang:1.20-alpine
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache git docker-cli make
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - |
      for SERVICE in $SERVICES; do
        echo "Building $SERVICE..."
        cd backend/applications/$SERVICE || exit 1
        go mod tidy
        go mod vendor
        docker build -t $DOCKER_IMAGE_PREFIX-$SERVICE:latest .
        docker push $DOCKER_IMAGE_PREFIX-$SERVICE:latest
        cd - > /dev/null
      done
  tags:
    - docker
  # Ensure the runner is configured to allow privileged mode for this tag
