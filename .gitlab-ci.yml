build:
  stage: build
  tags:
    - docker
  before_script:
    - apt-get update && apt-get install -y docker.io
    - export DOCKER_HOST="unix:///var/run/docker.sock"

  script:
    - |
      for SERVICE in $SERVICES; do
        echo "Building $SERVICE..."
        cd applications/$SERVICE || exit 1
        
        # Run go mod tidy and go mod vendor
        echo "Running go mod tidy and go mod vendor for $SERVICE..."
        go mod tidy
        go mod vendor
        
        # Build Docker image
        docker build -t $DOCKER_IMAGE_PREFIX-$SERVICE:latest .
        docker push $DOCKER_IMAGE_PREFIX-$SERVICE:latest
        
        cd - > /dev/null
      done
